(this["webpackJsonpmashup-ml-client"]=this["webpackJsonpmashup-ml-client"]||[]).push([[0],{14:function(t,e,a){t.exports=a(29)},27:function(t,e,a){},29:function(t,e,a){"use strict";a.r(e);var s=a(0),n=a.n(s),o=a(11),u=a.n(o),r=a(3),i=a(4),l=a(6),c=a(5),h=a(1),d=a(7),p=a(2),m=a(12),v=a.n(m),g=[[1,0,0,0],[1,0,0,0],[1,0,0,0],[1,0,0,0],[1,0,0,0],[1,0,0,0],[1,0,0,0],[1,0,0,0]],f=function(t){function e(t){var a;return Object(r.a)(this,e),(a=Object(l.a)(this,Object(c.a)(e).call(this,t))).state={pads:g,tracks:4,CurrentColumn:0,play:!1},a.addTrack=a.addTrack.bind(Object(h.a)(a)),a.getRandomTemplate=a.getRandomTemplate.bind(Object(h.a)(a)),a.startSequence=a.startSequence.bind(Object(h.a)(a)),a.stopSequence=a.stopSequence.bind(Object(h.a)(a)),a}return Object(d.a)(e,t),Object(i.a)(e,[{key:"togglePad",value:function(t,e){this.setState((function(a){var s=a.pads.slice(0),n=s[t][e];return s[t][e]=1===n?0:1,{pads:s}}))}},{key:"getRandomTemplate",value:function(){var t=this;this.state.tracks<2||(console.log("".concat(this.state.server_url,"/get_template/").concat(this.state.tracks)),fetch("".concat(this.state.server_url,"/get_template/").concat(this.state.tracks)).then((function(t){return t.json()})).then((function(e){return t.setState({pads:e.template})})))}},{key:"addTrack",value:function(){var t=this.state.pads,e=this.state.tracks;if(!(e>=9)){var a=t.slice(0).map((function(t){return t.push(0),t}));e+=1,this.setState({pads:a,tracks:e}),this.getRandomTemplate()}}},{key:"startSequence",value:function(){var t=this,e=new p.Sequence((function(e,a){t.setState({CurrentColumn:a});var s=t.state.pads[a],n=t.state.players;s.forEach((function(t,a){t&&n.get(a).start(e)})),console.log("sequence: ",e)}),v.a.range(8),"".concat(8,"n")).start();this.setState({sequence:e}),p.Transport.start(),this.setState({play:!0})}},{key:"stopSequence",value:function(){p.Transport.stop(),this.setState({play:!1})}},{key:"componentWillMount",value:function(){var t=this.props.server_url;this.setState({server_url:t})}},{key:"componentDidMount",value:function(){var t=this,e=this.props,a=e.urlsDecision,s=e.volumes,n=a.length;this.getRandomTemplate();for(var o=a.map((function(e){return"".concat(t.state.server_url,"/download_filepath?url=").concat(e)})),u=new p.Players(o,(function(){t.setState({players:u}),t.setState({tracks:n}),t.setState({urls:o})}),{volume:s}).toMaster(),r=0;r<o.length;r++)u.get(r).volume.value=s[r];p.Transport.bpm.value=20}},{key:"componentWillUnmount",value:function(){this.state.sequence&&(this.state.sequence.mute=!0,this.state.sequence.stop().removeAll()),console.log("will unmount")}},{key:"render",value:function(){var t=this,e=this.state.pads;return n.a.createElement("div",{className:"sequencer"},n.a.createElement("div",{className:"pads"},e.map((function(e,a){return n.a.createElement("div",{key:"pad-".concat(a)},n.a.createElement("div",{key:"progress-".concat(a),className:"progress ".concat(a==t.state.CurrentColumn&&" progress_on")}),e.map((function(e,s){return n.a.createElement("div",{key:"pad-group-".concat(s),className:"pad ".concat(1==e&&" pad_on"),onClick:function(){t.togglePad(a,s)}})})))}))),this.state.play?n.a.createElement("button",{className:"sub-btn",onClick:this.stopSequence},"Stop"):n.a.createElement("button",{className:"main-btn",onClick:this.startSequence},"Start"),n.a.createElement("button",{className:"main-btn",onClick:this.getRandomTemplate},"Get Template"))}}]),e}(s.Component);var k=function(t){function e(t){var a;return Object(r.a)(this,e),(a=Object(l.a)(this,Object(c.a)(e).call(this,t))).state={},a.canvasClick=a.canvasClick.bind(Object(h.a)(a)),a.drawWaveform=a.drawWaveform.bind(Object(h.a)(a)),a.connectAudio=a.connectAudio.bind(Object(h.a)(a)),a.disconnectAudio=a.disconnectAudio.bind(Object(h.a)(a)),a}return Object(d.a)(e,t),Object(i.a)(e,[{key:"drawWaveform",value:function(t,e,a,s){var n=this.canvas.getContext("2d"),o=function(t,e,a){for(var s=Math.ceil(t.length/e),n=a/2,o=[],u=0;u<e;u++){for(var r=1,i=-1,l=0;l<s;l++){var c=t[u*s+l];c<r&&(r=c),c>i&&(i=c)}o.push({x:u,y:(1+r)*n,width:1,height:Math.max(1,(i-r)*n)})}return o}(t,e,a);n.clearRect(0,0,e,a),n.fillStyle=s,o.forEach((function(t){return n.fillRect(t.x,t.y,t.width,t.height)}))}},{key:"canvasClick",value:function(){1==this.state.value?this.state.chooseColumn(-1):this.state.chooseColumn(this.state.index)}},{key:"connectAudio",value:function(){this.state.player&&(this.state.player.loop=!0,"stopped"==p.Transport.state?(this.state.player.sync().start(),p.Transport.start()):this.state.player.sync().restart().seek(p.Transport.seconds%this.state.player.buffer.duration),this.state.player.mute=!1)}},{key:"disconnectAudio",value:function(){this.state.player&&(this.state.player.loop=!1,this.state.player.mute=!0,this.state.player.stop().unsync())}},{key:"componentWillMount",value:function(){var t=this.props.server_url;this.setState({server_url:t})}},{key:"componentDidMount",value:function(){var t=this,e=this.props,a=e.url,s=e.value,n=e.index,o=e.colors,u=e.chooseColumn,r=e.loadCompleted;if(this.setState({url:a,value:s,index:n,colors:o,chooseColumn:u,loadCompleted:r}),null!=a)var i=new p.Player(a,(function(){var e=i.buffer.getChannelData();t.drawWaveform(e,t.canvas.width,t.canvas.height,o[0]),i.toMaster(),t.setState({player:i,data:e})}))}},{key:"componentDidUpdate",value:function(t,e){var a=this;if(t!=this.props){var s=this.props,n=s.index,o=s.url,u=s.value,r=s.colors,i=s.mute,l=s.currentLoadStatue,c=s.volume;if(c!=t.volume&&this.state.player&&(this.state.player.volume.value=c),null!=o&&(!this.state.player||1==l)){if(e.url==o)return;var h=new p.Player("".concat(this.state.server_url,"/download_filepath?url=").concat(o),(function(){var t=h.buffer.getChannelData();a.drawWaveform(t,a.canvas.width,a.canvas.height,r[0]),h.toMaster(),h.volume.value=-15,a.state.loadCompleted(),a.setState({player:h,data:t})}))}if(this.setState({url:o,value:u,index:n,colors:r}),this.state.player)if(i==t.mute){if(u==t.value)return;1==u?(this.drawWaveform(this.state.data,this.canvas.width,this.canvas.height,r[1]),this.connectAudio()):0==u&&(this.disconnectAudio(),this.drawWaveform(this.state.data,this.canvas.width,this.canvas.height,r[0]))}else this.state.player.mute=1==i}}},{key:"render",value:function(){var t=this;return n.a.createElement("div",{className:"waveform"},n.a.createElement("canvas",{className:"draw",ref:function(e){return t.canvas=e},style:{border:"1px solid ".concat(this.props.colors[0]),backgroundColor:"#0f4c81"},onClick:this.canvasClick}))}}]),e}(s.Component),S=["#F4F1EE","#FFF130"],b=function(t,e){return t+e},y=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:-40,s=t/100,n=a+(e-a)*s;return n},L=function(t){function e(t){var a;return Object(r.a)(this,e),(a=Object(l.a)(this,Object(c.a)(e).call(this,t))).state={urls:null,mute:!1,value:!1,players:null,loaded:0,volume:y(-15),playColumns:[0,0,0,0]},a.toggleLock=a.toggleLock.bind(Object(h.a)(a)),a.changeLoop=a.changeLoop.bind(Object(h.a)(a)),a.toggleMute=a.toggleMute.bind(Object(h.a)(a)),a.volumeAdjust=a.volumeAdjust.bind(Object(h.a)(a)),a.chooseColumn=a.chooseColumn.bind(Object(h.a)(a)),a.loadCompleted=a.loadCompleted.bind(Object(h.a)(a)),a}return Object(d.a)(e,t),Object(i.a)(e,[{key:"volumeAdjust",value:function(t){var e=y(t.target.value);this.state.updateVolmes(this.state.index,e),this.setState({volume:e})}},{key:"loadCompleted",value:function(){this.state.loaded>=4||this.setState({loaded:this.state.loaded+1})}},{key:"chooseColumn",value:function(t){if(!this.state.value){var e=[0,0,0,0];-1!=t&&(e[t]=1),this.state.updateDecision(this.state.index,this.state.urls[t]),this.setState({playColumns:e})}}},{key:"changeLoop",value:function(){if(1!=this.state.currentLoadStatue){var t=this.state.index,e=this.state.urlsDecision;0==t?this.state.getNextLoop(4):this.state.getNextLoop(t-1,e[t-1]),this.chooseColumn(-1)}else console.log("can not change, still loading")}},{key:"toggleLock",value:function(){if(0!=this.state.playColumns.reduce(b)){var t=this.state.value?0:1;this.state.updateLockStatue(this.state.index,t)}else alert("choose one loop")}},{key:"toggleMute",value:function(){0!=this.state.playColumns.reduce(b)?(this.state.sequencer&&(this.state.lockStatue[this.state.index]&&this.toggleLock(),this.state.toggleSequencer()),this.setState({mute:!this.state.mute})):alert("choose one loop")}},{key:"componentWillMount",value:function(){var t=this.props.server_url;this.setState({server_url:t})}},{key:"componentDidMount",value:function(){var t=this.props,e=t.index,a=t.value,s=t.urls,n=t.updateLockStatue,o=t.getNextLoop,u=t.updateDecision,r=t.toggleSequencer,i=t.updateLoadStatue,l=t.updateVolmes;this.setState({index:e,value:a,urls:s,updateLockStatue:n,getNextLoop:o,updateDecision:u,toggleSequencer:r,updateLoadStatue:i,updateVolmes:l})}},{key:"componentDidUpdate",value:function(t,e){if(e!=this.state&&4==this.state.loaded&&(this.setState({loaded:0}),this.state.updateLoadStatue(this.state.index,0)),t!=this.props){var a=this.props,s=a.index,n=a.value,o=a.urls,u=a.lockStatue,r=a.sequencer,i=a.currentLoadStatue,l=a.urlsDecision;r!=t.sequencer&&1==r&&(this.state.mute=!0),this.setState({index:s,value:n,urls:o,lockStatue:u,sequencer:r,currentLoadStatue:i,urlsDecision:l})}}},{key:"render",value:function(){var t=this;return n.a.createElement("div",{className:"loops"},this.state.playColumns.map((function(e,a){return n.a.createElement(k,{key:a,index:a,value:e,mute:t.state.mute,group_index:t.state.index,url:null==t.state.urls?null:t.state.urls[a],colors:S,volume:t.state.volume,chooseColumn:t.chooseColumn,loadCompleted:t.loadCompleted,currentLoadStatue:t.state.currentLoadStatue,server_url:t.state.server_url})})),this.state.value||this.state.currentLoadStatue?n.a.createElement("button",{className:"sub-btn"},"Later"):n.a.createElement("button",{className:"main-btn",onClick:this.changeLoop},"Change"),n.a.createElement("button",{className:this.state.value?"sub-btn":"main-btn",onClick:this.toggleLock},this.state.value?"unLock":"Lock"),this.state.mute?n.a.createElement("button",{className:"sub-btn",onClick:this.toggleMute},"unMute"):n.a.createElement("button",{className:"main-btn",onClick:this.toggleMute},"Mute"),n.a.createElement("input",{type:"range",min:"0",max:"100",className:"volume",onInput:this.volumeAdjust}))}}]),e}(s.Component),C=a(13),j=function(t,e){return t+e},O=function(t){function e(t){var a;return Object(r.a)(this,e),(a=Object(l.a)(this,Object(c.a)(e).call(this,t))).state={loadStatue:[0,0,0,0],lockStatue:[0,0,0,0],volumes:[-15,-15,-15,-15],groupUrls:[],urlsDecision:[],sequencer:!1,server_url:"https://musicai.citi.sinica.edu.tw/mashup_ml_server"},a.getMainLoop=a.getMainLoop.bind(Object(h.a)(a)),a.updateLockStatue=a.updateLockStatue.bind(Object(h.a)(a)),a.updateDecision=a.updateDecision.bind(Object(h.a)(a)),a.getAccompanyLoop=a.getAccompanyLoop.bind(Object(h.a)(a)),a.updateLoadStatue=a.updateLoadStatue.bind(Object(h.a)(a)),a.toggleSequencer=a.toggleSequencer.bind(Object(h.a)(a)),a.updateVolmes=a.updateVolmes.bind(Object(h.a)(a)),a}return Object(d.a)(e,t),Object(i.a)(e,[{key:"updateVolmes",value:function(t,e){console.log(t,e);var a=this.state.volumes;a[t]=e,this.setState({volumes:a})}},{key:"getMainLoop",value:function(t){var e=this,a="".concat(this.state.server_url,"/get_main_loop/").concat(t);console.log(a),this.updateLoadStatue(0,1),fetch(a,{method:"GET"}).then((function(t){if(!t.ok)throw e.updateLoadStatue(0,0),new Error(t.statusText);return t.json()})).then((function(t){var a;console.log("main loop"),e.state.groupUrls[0]?a=[t.main]:(a=e.state.groupUrls)[0]=t.main,e.setState({groupUrls:a})}))}},{key:"getAccompanyLoop",value:function(t,e){var a=this,s="".concat(this.state.server_url,"/get_mashup_result?url=").concat(e,"&num=",100);this.state.groupUrls.length==t+1&&(this.state.groupUrls.push([]),this.setState({groupUrls:this.state.groupUrls})),this.updateLoadStatue(t+1,1),fetch(s,{method:"GET"}).then((function(e){if(!e.ok)throw a.updateLoadStatue(t+1,0),new Error(e.statusText);return e.json()})).then((function(e){console.log("accompany loop");var s=a.state.groupUrls;return s[t+1]=e.rank.slice(0,4),a.setState({groupUrls:s}),e.rank}))}},{key:"updateLoadStatue",value:function(t,e){var a=this.state.loadStatue;a[t]=e,this.setState({loadStatue:a})}},{key:"updateDecision",value:function(t,e){this.state.urlsDecision.length<t+1?this.state.urlsDecision.push(e):this.state.urlsDecision[t]=e,this.setState({urlsDecision:this.state.urlsDecision})}},{key:"updateLockStatue",value:function(t,e){var a=this.state;a.lockStatue[t]=e,4==a.lockStatue.reduce(j)?(this.setState({lockStatue:a.lockStatue}),this.state.sequencer||this.toggleSequencer()):(1==e&&(console.log("update lock ",t),this.getAccompanyLoop(t,this.state.urlsDecision[t])),this.setState({lockStatue:a.lockStatue}))}},{key:"toggleSequencer",value:function(){this.setState({sequencer:!this.state.sequencer})}},{key:"componentDidMount",value:function(){console.log(this.state),this.getMainLoop(4)}},{key:"render",value:function(){var t=this;return n.a.createElement("div",{className:"App"},n.a.createElement(C.Helmet,null," ",n.a.createElement("title",null,"ML Mashup")," "),n.a.createElement("h1",null,"Interactive Beat Makers"),this.state.groupUrls.map((function(e,a){return n.a.createElement(L,{key:a,urls:e,index:a,sequencer:t.state.sequencer,value:t.state.lockStatue[a],currentLoadStatue:t.state.loadStatue[a],lockStatue:t.state.lockStatue,updateLockStatue:t.updateLockStatue,urlsDecision:t.state.urlsDecision,getNextLoop:0!=a?t.getAccompanyLoop:t.getMainLoop,updateDecision:t.updateDecision,toggleSequencer:t.toggleSequencer,updateLoadStatue:t.updateLoadStatue,updateVolmes:t.updateVolmes,server_url:t.state.server_url})})),this.state.sequencer&&n.a.createElement(f,{server_url:this.state.server_url,volumes:this.state.volumes,urlsDecision:this.state.urlsDecision}))}}]),e}(s.Component);a(27),a(28);u.a.render(n.a.createElement(O,null),document.getElementById("root"))}},[[14,1,2]]]);
//# sourceMappingURL=main.4173c2d0.chunk.js.map